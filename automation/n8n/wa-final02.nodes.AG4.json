{"nodes":[
{"name":"API_Slots_AG","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"GET","url":"http://barberbook-api:8080/api/slots?serviceId={{$json.serviceId}}&date={{$json.date}}","jsonParameters":true},"position":[1120,60]},
{"name":"FormatSlots_AG","type":"n8n-nodes-base.function","typeVersion":1,"parameters":{"functionCode":"const raw=$json.body||$json.data||$json.result||$json.slots||[];const a=Array.isArray(raw)?raw:(raw.slots||[]);const top=(a||[]).slice(0,5);function hhmm(x){try{return new Date(x).toISOString().slice(11,16);}catch{return x||''}}const slots=top.map((s,i)=>({startUtc:s.startUtc||s.start||s.startISO||s.start_time,endUtc:s.endUtc||s.end||s.endISO||s.end_time,display:s.display||hhmm(s.startUtc)}));const listText=slots.map((s,i)=>`${i+1}) ${s.display}`).join('\\n');return [{json:{...$json,slots,listText,hasSlots:slots.length>0}}];"},"position":[1280,60]},
{"name":"IfHasSlots_AG","type":"n8n-nodes-base.if","typeVersion":1,"parameters":{"conditions":{"boolean":[{"value1":"={{$json.hasSlots}}"}]}},"position":[1440,60]},
{"name":"WAHA_NoSlots_AG","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Sem horarios nesse dia. Quer tentar outra data?\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[1600,0]},
{"name":"SaveState_AG","type":"n8n-nodes-base.redis","typeVersion":1,"parameters":{"operation":"set","key":"state:{{$json.chatId}}","value":"={{JSON.stringify($json)}}","ttl":1800},"position":[1600,120]},
{"name":"WAHA_List_AG","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Escolha:\\n{{$json.listText}}\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[1760,120]}
]}
