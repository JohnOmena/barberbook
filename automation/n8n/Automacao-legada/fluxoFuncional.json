{
    "name":  "Whatsapp",
    "nodes":  [
                  {
                      "parameters":  {
                                         "httpMethod":  "POST",
                                         "path":  "wa-incoming",
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.webhook",
                      "typeVersion":  2.1,
                      "position":  [
                                       0,
                                       0
                                   ],
                      "id":  "dbb0b386-7b03-4131-b254-bf6af32fb258",
                      "name":  "Webhook",
                      "webhookId":  "12c1238d-e643-4a30-8325-50a08c08d452"
                  },
                  {
                      "parameters":  {
                                         "assignments":  {
                                                             "assignments":  [
                                                                                 {
                                                                                     "id":  "263475a2-ecda-4f08-b3ae-d1b6b103aa82",
                                                                                     "name":  "session",
                                                                                     "value":  "={{ $json.body.session }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "2badd492-5014-4a4c-96dd-805e1caef1e2",
                                                                                     "name":  "chatId",
                                                                                     "value":  "={{ $json.body.payload.from }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "50c1e2cf-5ad8-4963-a7c5-f89dc37ac94c",
                                                                                     "name":  "pushName",
                                                                                     "value":  "={{ $json.body.payload._data.Info.PushName }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "4e6a3de6-bed1-4cc3-83c7-c6209fa112de",
                                                                                     "name":  "payload_id",
                                                                                     "value":  "={{ $json.body.payload.id }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "f112b63e-8f46-4a2f-a9bd-e28a37edec98",
                                                                                     "name":  "event",
                                                                                     "value":  "={{ $json.body.event }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "aaeabb47-904a-4cd9-a6d2-3f96af173d20",
                                                                                     "name":  "message",
                                                                                     "value":  "={{ $json.body.payload.body }}",
                                                                                     "type":  "string"
                                                                                 },
                                                                                 {
                                                                                     "id":  "7481ded0-b65c-4a98-a73f-c0e301cfd42f",
                                                                                     "name":  "fromMe",
                                                                                     "value":  "={{ $json.body.payload.fromMe }}",
                                                                                     "type":  "string"
                                                                                 }
                                                                             ]
                                                         },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.set",
                      "typeVersion":  3.4,
                      "position":  [
                                       208,
                                       0
                                   ],
                      "id":  "d3ab353e-2d8e-45ae-a730-f20060ba3368",
                      "name":  "Dados"
                  },
                  {
                      "parameters":  {
                                         "rules":  {
                                                       "values":  [
                                                                      {
                                                                          "conditions":  {
                                                                                             "options":  {
                                                                                                             "caseSensitive":  true,
                                                                                                             "leftValue":  "",
                                                                                                             "typeValidation":  "strict",
                                                                                                             "version":  2
                                                                                                         },
                                                                                             "conditions":  [
                                                                                                                {
                                                                                                                    "leftValue":  "={{ $json.event }}",
                                                                                                                    "rightValue":  "={{ $json.message }}",
                                                                                                                    "operator":  {
                                                                                                                                     "type":  "string",
                                                                                                                                     "operation":  "equals"
                                                                                                                                 },
                                                                                                                    "id":  "2778fa77-33ed-4a9f-89a4-e8e8ae860aef"
                                                                                                                }
                                                                                                            ],
                                                                                             "combinator":  "and"
                                                                                         }
                                                                      }
                                                                  ]
                                                   },
                                         "options":  {

                                                     }
                                     },
                      "type":  "n8n-nodes-base.switch",
                      "typeVersion":  3.2,
                      "position":  [
                                       416,
                                       0
                                   ],
                      "id":  "4ae68735-4852-463c-ab16-4495f7d340a2",
                      "name":  "Switch",
                      "alwaysOutputData":  true
                  },
                  {
                      "parameters":  {
                                         "options":  {
                                                         "temperature":  0.2
                                                     },
                                         "modelName":  "models/gemini-1.5-flash-8b"
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
                      "typeVersion":  1,
                      "position":  [
                                       496,
                                       208
                                   ],
                      "id":  "f04541b6-e95c-4194-b3f4-cf5f1a94915c",
                      "name":  "Google Gemini Chat Model",
                      "credentials":  {
                                          "googlePalmApi":  {
                                                                "id":  "cred-gemini-api",
                                                                "name":  "Gemini API"
                                                            }
                                      }
                  },
                  {
                      "parameters":  {
                                         "sessionIdType":  "customKey",
                                         "sessionKey":  "={{ $(\u0027Dados\u0027).item.json.chatId }}",
                                         "sessionTTL":  3600,
                                         "contextWindowLength":  10
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.memoryRedisChat",
                      "typeVersion":  1.5,
                      "position":  [
                                       736,
                                       224
                                   ],
                      "id":  "43d6e708-c63e-47cb-8260-cc2858d437cc",
                      "name":  "Redis Chat Memory",
                      "credentials":  {
                                          "redis":  {
                                                        "id":  "cred-redis-account",
                                                        "name":  "Redis account"
                                                    }
                                      }
                  },
                  {
                      "parameters":  {
                                         "resource":  "Chatting",
                                         "operation":  "Send Text",
                                         "session":  "={{ $(\u0027Dados\u0027).item.json.session }}",
                                         "chatId":  "={{ $(\u0027Dados\u0027).item.json.chatId }}",
                                         "text":  "={{ $(\u0027AI Agent\u0027).item.json.output }}",
                                         "requestOptions":  {

                                                            }
                                     },
                      "type":  "n8n-nodes-waha.WAHA",
                      "typeVersion":  202411,
                      "position":  [
                                       1456,
                                       -64
                                   ],
                      "id":  "5d1b2237-8f58-4712-a11c-03db33aa14aa",
                      "name":  "Send a text message",
                      "credentials":  {
                                          "wahaApi":  {
                                                          "id":  "cred-waha-account-2",
                                                          "name":  "WAHA account 2"
                                                      }
                                      }
                  },
                  {
                      "parameters":  {
                                         "resource":  "Chatting",
                                         "operation":  "Send Seen",
                                         "session":  "={{ $(\u0027Dados\u0027).item.json.session }}",
                                         "chatId":  "={{ $(\u0027Dados\u0027).item.json.chatId }}",
                                         "messageId":  "={{ $(\u0027Dados\u0027).item.json.payload_id }}",
                                         "participant":  "",
                                         "requestOptions":  {

                                                            }
                                     },
                      "type":  "n8n-nodes-waha.WAHA",
                      "typeVersion":  202411,
                      "position":  [
                                       1136,
                                       64
                                   ],
                      "id":  "febb45a3-04c9-4626-831c-0da1c2dd07cb",
                      "name":  "Send Seen1",
                      "credentials":  {
                                          "wahaApi":  {
                                                          "id":  "cred-waha-account-2",
                                                          "name":  "WAHA account 2"
                                                      }
                                      }
                  },
                  {
                      "parameters":  {
                                         "promptType":  "define",
                                         "text":  "={{ $(\u0027Dados\u0027).item.json.message }}",
                                         "options":  {
                                                         "systemMessage":  "Você é o agente de agendamentos do BarberBook (barbearia). Seu objetivo é levar o cliente a um agendamento confirmado ou a um cancelamento, pedindo apenas a informação que falta em cada passo.\n\nRegras de comunicação:\n- Idioma: português do Brasil. Tom: profissional, cordial e direto.\n- Mensagens curtas (1–3 linhas). Faça só uma pergunta por vez.\n- Não use Markdown, emojis ou listas longas.\n- Identidade: apresente-se como “BarberBook”. Nunca diga que é um modelo de linguagem, IA genérica ou que não pode agendar. Se perguntarem “quem é você?”, responda: “Sou o assistente de agendamentos da BarberBook.”\n\nRegras de negócio:\n- Dados mínimos para agendar: serviço + data + horário.\n- Serviços: use apenas os serviços existentes no sistema. Se não reconhecer, peça para escolher entre os disponíveis.\n- Datas/horas:\n  - Aceite linguagem natural (“amanhã”, “terça”, “dia 20”) e horários 24h (“14:00”). Fuso: America/Sao_Paulo.\n  - Não prometa horário. Aguarde a lista numerada enviada pelo sistema e instrua: “Responda com o número do horário desejado ou 0 para cancelar.”\n  - Se a data for inválida/indefinida, peça a data novamente de forma objetiva.\n- Lista de horários: quando o sistema enviar, não replique a lista; apenas peça o número.\n- Seleção de horário: após o número, aguarde a confirmação do sistema. Não confirme por conta própria.\n- Confirmação: se vier a confirmação com ID, responda, caso necessário: “Agendado: {serviço} às {hora} do dia {data}. ID: {id}. Para cancelar, responda: cancelar {id}.”\n- Cancelamento:\n  - “cancelar 123” → encaminhe para cancelamento.\n  - “cancelar” sem ID → peça o ID do agendamento.\n- Dúvidas/erros:\n  - Peça só o que falta: “Qual serviço?”, “Para qual data?”, “Qual horário?”.\n  - Se o horário esgotar, informe e ofereça ver outras opções.\n- Informações adicionais: só informe preço/duração se o cliente pedir e se o dado estiver disponível.\n- Privacidade: não peça dados sensíveis (CPF, cartão etc.).\n- Resumo: se a conversa ficar confusa, recapitulhe: “Tenho: serviço X e data Y. Falta o horário.”\n\nComandos do cliente:\n- “agendar \u003cserviço\u003e \u003cdata\u003e \u003chora\u003e”\n- “cancelar \u003cid\u003e”\n- “ver horários \u003cdata\u003e \u003cserviço\u003e”"
                                                     }
                                     },
                      "type":  "@n8n/n8n-nodes-langchain.agent",
                      "typeVersion":  2.2,
                      "position":  [
                                       640,
                                       16
                                   ],
                      "id":  "86a82532-99be-4bdd-b99e-443a6e262261",
                      "name":  "AI Agent"
                  },
                  {
                      "parameters":  {
                                         "amount":  2
                                     },
                      "type":  "n8n-nodes-base.wait",
                      "typeVersion":  1.1,
                      "position":  [
                                       976,
                                       -32
                                   ],
                      "id":  "9f01e742-b615-4cc4-9783-5b0ba94db93f",
                      "name":  "Wait",
                      "webhookId":  "afffeaa3-7208-49c2-9093-c1ea2c11a2a2"
                  },
                  {
                      "parameters":  {
                                         "amount":  2
                                     },
                      "type":  "n8n-nodes-base.wait",
                      "typeVersion":  1.1,
                      "position":  [
                                       1264,
                                       -80
                                   ],
                      "id":  "245f5ade-6540-42a8-afaa-63c39d705005",
                      "name":  "Wait1",
                      "webhookId":  "afffeaa3-7208-49c2-9093-c1ea2c11a2a2"
                  }
              ],
    "pinData":  {
                    "Webhook":  [
                                    {
                                        "json":  {
                                                     "headers":  {
                                                                     "accept":  "application/json, text/plain, */*",
                                                                     "content-type":  "application/json",
                                                                     "user-agent":  "WAHA/2025.8.1",
                                                                     "x-webhook-request-id":  "01K2Y7RXE305JVWK77VEPTM8KD",
                                                                     "x-webhook-timestamp":  "1755508929987",
                                                                     "content-length":  "2419",
                                                                     "accept-encoding":  "gzip, compress, deflate, br",
                                                                     "host":  "host.docker.internal:5678",
                                                                     "connection":  "keep-alive"
                                                                 },
                                                     "params":  {

                                                                },
                                                     "query":  {

                                                               },
                                                     "body":  {
                                                                  "id":  "evt_01k2y7rxe33g1y86z9v4ms9zxt",
                                                                  "timestamp":  1755508929987,
                                                                  "event":  "message",
                                                                  "session":  "default",
                                                                  "metadata":  {

                                                                               },
                                                                  "me":  {
                                                                             "id":  "553591450802@c.us",
                                                                             "pushName":  "Gabriela Marques",
                                                                             "jid":  "553591450802:1@s.whatsapp.net"
                                                                         },
                                                                  "payload":  {
                                                                                  "id":  "false_556291384072@c.us_3A283E37451426367DF3",
                                                                                  "timestamp":  1755508929,
                                                                                  "from":  "556291384072@c.us",
                                                                                  "fromMe":  false,
                                                                                  "source":  "app",
                                                                                  "body":  "oi",
                                                                                  "to":  null,
                                                                                  "participant":  null,
                                                                                  "hasMedia":  false,
                                                                                  "media":  null,
                                                                                  "ack":  2,
                                                                                  "ackName":  "DEVICE",
                                                                                  "replyTo":  null,
                                                                                  "_data":  {
                                                                                                "Info":  {
                                                                                                             "Chat":  "556291384072@s.whatsapp.net",
                                                                                                             "Sender":  "556291384072@s.whatsapp.net",
                                                                                                             "IsFromMe":  false,
                                                                                                             "IsGroup":  false,
                                                                                                             "AddressingMode":  "",
                                                                                                             "SenderAlt":  "58592547848335@lid",
                                                                                                             "RecipientAlt":  "",
                                                                                                             "BroadcastListOwner":  "",
                                                                                                             "ID":  "3A283E37451426367DF3",
                                                                                                             "ServerID":  0,
                                                                                                             "Type":  "text",
                                                                                                             "PushName":  "Guilherme Franklim - GLE DIGITAL",
                                                                                                             "Timestamp":  "2025-08-18T09:22:09Z",
                                                                                                             "Category":  "",
                                                                                                             "Multicast":  false,
                                                                                                             "MediaType":  "",
                                                                                                             "Edit":  "",
                                                                                                             "MsgBotInfo":  {
                                                                                                                                "EditType":  "",
                                                                                                                                "EditTargetID":  "",
                                                                                                                                "EditSenderTimestampMS":  "0001-01-01T00:00:00Z"
                                                                                                                            },
                                                                                                             "MsgMetaInfo":  {
                                                                                                                                 "TargetID":  "",
                                                                                                                                 "TargetSender":  "",
                                                                                                                                 "TargetChat":  "",
                                                                                                                                 "DeprecatedLIDSession":  null,
                                                                                                                                 "ThreadMessageID":  "",
                                                                                                                                 "ThreadMessageSenderJID":  ""
                                                                                                                             },
                                                                                                             "VerifiedName":  {
                                                                                                                                  "Certificate":  {
                                                                                                                                                      "details":  "CP/0mKfs0bYkEgZzbWI6d2EiIEd1aWxoZXJtZSBGcmFua2xpbSAtIEdMRSBESUdJVEFM",
                                                                                                                                                      "signature":  "7WMFCZlk61acXndBJKD11dFQdyj5Xna8uJzVQYg84JrO79Ze2XtmZEGl2sF2OuKIyOfss1sJAh0YpK50gp4/hA=="
                                                                                                                                                  },
                                                                                                                                  "Details":  {
                                                                                                                                                  "serial":  20506505046801024,
                                                                                                                                                  "issuer":  "smb:wa",
                                                                                                                                                  "verifiedName":  "Guilherme Franklim - GLE DIGITAL"
                                                                                                                                              }
                                                                                                                              },
                                                                                                             "DeviceSentMeta":  null
                                                                                                         },
                                                                                                "Message":  {
                                                                                                                "conversation":  "oi",
                                                                                                                "messageContextInfo":  {
                                                                                                                                           "deviceListMetadata":  {
                                                                                                                                                                      "senderKeyHash":  "aoHFdvw/Y+vq0g==",
                                                                                                                                                                      "senderTimestamp":  1754902383,
                                                                                                                                                                      "recipientKeyHash":  "rV69gnsoDy5kSQ==",
                                                                                                                                                                      "recipientTimestamp":  1755508618
                                                                                                                                                                  },
                                                                                                                                           "deviceListMetadataVersion":  2,
                                                                                                                                           "messageSecret":  "hGtW3Xb+2B1h2f5z4i1nDz+BNh7+8MSWdqO59xdx0DM="
                                                                                                                                       }
                                                                                                            },
                                                                                                "IsEphemeral":  false,
                                                                                                "IsViewOnce":  false,
                                                                                                "IsViewOnceV2":  false,
                                                                                                "IsViewOnceV2Extension":  false,
                                                                                                "IsDocumentWithCaption":  false,
                                                                                                "IsLottieSticker":  false,
                                                                                                "IsEdit":  false,
                                                                                                "SourceWebMsg":  null,
                                                                                                "UnavailableRequestID":  "",
                                                                                                "RetryCount":  0,
                                                                                                "NewsletterMeta":  null,
                                                                                                "RawMessage":  {
                                                                                                                   "conversation":  "oi",
                                                                                                                   "messageContextInfo":  {
                                                                                                                                              "deviceListMetadata":  {
                                                                                                                                                                         "senderKeyHash":  "aoHFdvw/Y+vq0g==",
                                                                                                                                                                         "senderTimestamp":  1754902383,
                                                                                                                                                                         "recipientKeyHash":  "rV69gnsoDy5kSQ==",
                                                                                                                                                                         "recipientTimestamp":  1755508618
                                                                                                                                                                     },
                                                                                                                                              "deviceListMetadataVersion":  2,
                                                                                                                                              "messageSecret":  "hGtW3Xb+2B1h2f5z4i1nDz+BNh7+8MSWdqO59xdx0DM="
                                                                                                                                          }
                                                                                                               },
                                                                                                "Status":  3
                                                                                            }
                                                                              },
                                                                  "environment":  {
                                                                                      "version":  "2025.8.1",
                                                                                      "engine":  "GOWS",
                                                                                      "tier":  "CORE",
                                                                                      "browser":  null
                                                                                  }
                                                              },
                                                     "webhookUrl":  "http://host.docker.internal:5678/webhook-test/webhook",
                                                     "executionMode":  "test"
                                                 }
                                    }
                                ]
                },
    "connections":  {
                        "Webhook":  {
                                        "main":  [
                                                     [
                                                         {
                                                             "node":  "Dados",
                                                             "type":  "main",
                                                             "index":  0
                                                         }
                                                     ]
                                                 ]
                                    },
                        "Dados":  {
                                      "main":  [
                                                   [
                                                       {
                                                           "node":  "Switch",
                                                           "type":  "main",
                                                           "index":  0
                                                       }
                                                   ]
                                               ]
                                  },
                        "Switch":  {
                                       "main":  [
                                                    [
                                                        {
                                                            "node":  "AI Agent",
                                                            "type":  "main",
                                                            "index":  0
                                                        }
                                                    ]
                                                ]
                                   },
                        "Send Seen1":  {
                                           "main":  [
                                                        [
                                                            {
                                                                "node":  "Wait1",
                                                                "type":  "main",
                                                                "index":  0
                                                            }
                                                        ]
                                                    ]
                                       },
                        "AI Agent":  {
                                         "main":  [
                                                      [
                                                          {
                                                              "node":  "Wait",
                                                              "type":  "main",
                                                              "index":  0
                                                          }
                                                      ]
                                                  ]
                                     },
                        "Redis Chat Memory":  {
                                                  "ai_memory":  [
                                                                    [
                                                                        {
                                                                            "node":  "AI Agent",
                                                                            "type":  "ai_memory",
                                                                            "index":  0
                                                                        }
                                                                    ]
                                                                ]
                                              },
                        "Google Gemini Chat Model":  {
                                                         "ai_languageModel":  [
                                                                                  [
                                                                                      {
                                                                                          "node":  "AI Agent",
                                                                                          "type":  "ai_languageModel",
                                                                                          "index":  0
                                                                                      }
                                                                                  ]
                                                                              ]
                                                     },
                        "Send a text message":  {
                                                    "main":  [
                                                                 [

                                                                 ]
                                                             ]
                                                },
                        "Wait":  {
                                     "main":  [
                                                  [
                                                      {
                                                          "node":  "Send Seen1",
                                                          "type":  "main",
                                                          "index":  0
                                                      }
                                                  ]
                                              ]
                                 },
                        "Wait1":  {
                                      "main":  [
                                                   [
                                                       {
                                                           "node":  "Send a text message",
                                                           "type":  "main",
                                                           "index":  0
                                                       }
                                                   ]
                                               ]
                                  }
                    },
    "active":  true,
    "settings":  {
                     "executionOrder":  "v1"
                 },
    "versionId":  "fc190303-8117-4b70-8d41-1ba40b23064e",
    "meta":  {
                 "templateCredsSetupCompleted":  true,
                 "instanceId":  "9c9c472f088125ec43dd9d78cbaf3aff4b4be15684694fd9fb20aff74262aacf"
             },
    "id":  "EpLVBNYyy494x8jp",
    "tags":  [
                 {
                     "createdAt":  "2025-09-14T18:52:41.541Z",
                     "updatedAt":  "2025-09-14T18:52:41.541Z",
                     "id":  "HShgCAp90lWr4iVI",
                     "name":  "Whatsapp"
                 }
             ]
}
