{"nodes":[
{"name":"IfDateMissing_RM","type":"n8n-nodes-base.if","typeVersion":1,"parameters":{"conditions":{"string":[{"value1":"={{$json.date}}","operation":"isEmpty"}]}},"position":[0,520]},
{"name":"WAHA_AskDate_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Qual a nova data? (YYYY-MM-DD)\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[160,460]},
{"name":"Gemini_DateNormalize_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","jsonParameters":true,"options":{"responseFormat":"json"},"headerParametersJson":"{\"x-goog-api-key\":\"AIzaSyAQdhMQ-aMy0H7rW3QuQ29nhImz5GhlYLY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Saida apenas JSON {\\\"date\\\": \\\"YYYY-MM-DD\\\"|null}. Base: {{$json.text}} {{$json.date||''}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"},"position":[160,580]},
{"name":"ApplyDate_RM","type":"n8n-nodes-base.function","typeVersion":1,"parameters":{"functionCode":"let d=$json.date||'';try{if(typeof d==='string'&&d.trim().startsWith('{')){d=JSON.parse(d).date||'';}}catch{};const ok=/^\\d{4}-\\d{2}-\\d{2}$/.test(d);return [{json:{...$json,date:d,validDateR:ok}}];"},"position":[320,580]},
{"name":"IfDateValid_RM","type":"n8n-nodes-base.if","typeVersion":1,"parameters":{"conditions":{"boolean":[{"value1":"={{$json.validDateR}}"}]}},"position":[480,580]},
{"name":"WAHA_DateInvalid_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Data invalida. Use YYYY-MM-DD.\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[640,520]},
{"name":"IfServiceMissing_RM","type":"n8n-nodes-base.if","typeVersion":1,"parameters":{"conditions":{"string":[{"value1":"={{$json.serviceId}}","operation":"isEmpty"}]}},"position":[640,640]},
{"name":"WAHA_AskService_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Qual servico?\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[800,600]},
{"name":"API_Slots_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"GET","url":"http://barberbook-api:8080/api/slots?serviceId={{$json.serviceId}}&date={{$json.date}}","jsonParameters":true},"position":[800,680]},
{"name":"FormatSlots_RM","type":"n8n-nodes-base.function","typeVersion":1,"parameters":{"functionCode":"const raw=$json.body||$json.data||$json.result||$json.slots||[];const a=Array.isArray(raw)?raw:(raw.slots||[]);const top=(a||[]).slice(0,5);function hhmm(x){try{return new Date(x).toISOString().slice(11,16);}catch{return x||''}}const slots=top.map((s,i)=>({startUtc:s.startUtc||s.start||s.startISO||s.start_time,endUtc:s.endUtc||s.end||s.endISO||s.end_time,display:s.display||hhmm(s.startUtc)}));const listText_R=slots.map((s,i)=>`${i+1}) ${s.display}`).join('\\n');return [{json:{...$json,slots,listText_R,hasSlotsR:slots.length>0}}];"},"position":[960,680]},
{"name":"IfHasSlots_RM","type":"n8n-nodes-base.if","typeVersion":1,"parameters":{"conditions":{"boolean":[{"value1":"={{$json.hasSlotsR}}"}]}},"position":[1120,680]},
{"name":"WAHA_NoSlots_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Sem horarios nesse dia. Quer tentar outra data?\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[1280,620]},
{"name":"SaveState_RM","type":"n8n-nodes-base.redis","typeVersion":1,"parameters":{"operation":"set","key":"state:{{$json.chatId}}","value":"={{JSON.stringify($json)}}","ttl":1800},"position":[1280,740]},
{"name":"WAHA_List_RM","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Escolha:\\n{{$json.listText_R}}\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[1440,740]},
{"name":"WAHA_Other","type":"n8n-nodes-base.httpRequest","typeVersion":1,"parameters":{"method":"POST","url":"http://waha:3000/api/sendText","jsonParameters":true,"headerParametersJson":"{\"Content-Type\":\"application/json\"}","bodyParametersJson":"{\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Posso ajudar com agendar, cancelar ou remarcar?\",\"reply_to\":\"{{$json.messageId}}\"}"},"position":[0,700]}
]}
