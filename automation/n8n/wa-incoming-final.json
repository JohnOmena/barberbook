{"name":"wa-incoming (final)","nodes":[{"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[200,300],"parameters":{"path":"wa-incoming","httpMethod":"POST","responseMode":"responseNode"}},{"id":"FunctionParse","name":"Parse WAHA","type":"n8n-nodes-base.function","typeVersion":1,"position":[460,300],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const r=item.json||{};const b=(r.body??r.data??r.payload??r.message??r.msg??{});const p=(b.payload??b.message??b.msg??r.payload??{});const chatId=(b.chatId??p.chatId??p.from??b.from??(b.key?.remoteJid)??(p.key?.remoteJid)??'');let text=(b.text??b.body??b.message?.text??b.message?.conversation??b.messages?.[0]?.text?.body??p.text??p.body??r.text??'');text=(typeof text==='string'?text.trim():(text!=null?JSON.stringify(text):''));const fromMe=Boolean(p.fromMe??b.fromMe??r.fromMe??false);const pushName=(r.me?.pushName??b.me?.pushName??p.me?.pushName??r.pushName??b.pushName??p.pushName??'')||'';const messageId=(p.id??b.id??b.key?.id??p.key?.id??'');return {json:{chatId,text,fromMe,pushName,messageId,session:'default'}};});"}},{"id":"IFNode","name":"fromMe?","type":"n8n-nodes-base.if","typeVersion":1,"position":[720,300],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.fromMe}}","value2":true}]}}},{"id":"WAHASeen","name":"WAHA Seen","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[980,220],"parameters":{"url":"http://waha:3000/api/sendSeen","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\"}"}},{"id":"RespondFromMe","name":"Respond OK (fromMe)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1240,220],"parameters":{"responseFormat":"string","responseBody":"OK (fromMe)","responseCode":200}},{"id":"RedisLoadStateChoose","name":"Redis Load State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[980,500],"parameters":{"command":"get","key":"=state:{{$json.chatId}}"}},{"id":"IfHasStateChoose","name":"Tem State?","type":"n8n-nodes-base.if","typeVersion":1,"position":[1240,500],"parameters":{"conditions":{"string":[{"value1":"={{$json.value}}","operation":"isNotEmpty"}]}}},{"id":"PickOptionChoose","name":"Pick Option","type":"n8n-nodes-base.function","typeVersion":1,"position":[1500,500],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let state=null;try{if(j.value) state=JSON.parse(j.value);}catch(e){state=null;}const slots=Array.isArray(state?.slots)?state.slots:[];const txt=String(j.text||'');const m=txt.match(/\d+/);const n=m?parseInt(m[0],10):NaN;let optionValid=Number.isInteger(n)&&n>=1&&n<=5&&n<=slots.length;let selectedStartUtc=null;if(optionValid) selectedStartUtc=slots[n-1]?.startUtc??null;optionValid=optionValid&&!!selectedStartUtc;const serviceId=state?.serviceId??null;const serviceName=state?.serviceName??null;const date=state?.date??null;return {json:{...j,optionValid,selectedStartUtc,serviceId,serviceName,date}};});"}},{"id":"IfOptionValidChoose","name":"opÃ§Ã£o vÃ¡lida?","type":"n8n-nodes-base.if","typeVersion":1,"position":[1760,500],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.optionValid}}","value2":true}]}}},{"id":"WahaInvalidOptionChoose","name":"WAHA OpÃ§Ã£o invÃ¡lida","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2020,480],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"OpÃ§Ã£o invÃ¡lida. Envie um nÃºmero da lista.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ApiBookChoose","name":"API Book","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2020,560],"parameters":{"url":"http://barberbook-api:8080/api/book","method":"POST","jsonParameters":true,"options":{"fullResponse":true},"headerParametersJson":"={\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"serviceId\":\"{{$json.serviceId}}\",\"startUtc\":\"{{$json.selectedStartUtc}}\",\"clientName\":\"{{$json.pushName || 'Cliente'}}\",\"clientContact\":\"{{$json.chatId}}\"}"}},{"id":"IfConflictChoose","name":"conflito?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2280,560],"parameters":{"conditions":{"number":[{"value1":"={{$json.statusCode}}","operation":"equal","value2":409}]}}},{"id":"WahaConflictChoose","name":"WAHA Conflito","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2540,540],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Esse horÃ¡rio esgotou agora. Quer ver outras opÃ§Ãµes?\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"WahaConfirmadoChoose","name":"WAHA Confirmado","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2540,600],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Agendado âœ…: {{$json.serviceName}} em {{$json.selectedStartUtc}} (UTC).\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"RedisClearChoose","name":"Redis Clear State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[2800,600],"parameters":{"command":"del","key":"=state:{{$json.chatId}}"}},{"id":"GeminiIntent","name":"Gemini Intent","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[980,420],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Classifique a intenÃ§Ã£o desta mensagem de WhatsApp em PT-BR.\\nResponda APENAS JSON com: {\\\"intent\\\":\\\"agendar|cancelar|remarcar|outro\\\",\\\"service\\\":string|null,\\\"date\\\":YYYY-MM-DD|null}.\\nMensagem: {{$json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ParseAI","name":"Parse AI","type":"n8n-nodes-base.function","typeVersion":1,"position":[1240,420],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let parsed={};const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{parsed=JSON.parse(m[0]);}catch(e){parsed={};}}else{try{parsed=JSON.parse(t);}catch(e){parsed={};}}let intent=parsed.intent;const intents=['agendar','cancelar','remarcar','outro'];if(!intents.includes(intent))intent='outro';const service=(parsed.service===null||typeof parsed.service==='string')?parsed.service:null;let date=parsed.date??null;if(typeof date==='string'){const mm=date.match(/^(\d{4}-\d{2}-\d{2})/);date=mm?mm[1]:null;}else{date=null;}return {json:{intent,service,date}};});"}},{"id":"MergeWAHA","name":"Merge WAHA+AI","type":"n8n-nodes-base.merge","typeVersion":1,"position":[1500,420],"parameters":{"mode":"mergeByPosition"}},{"id":"SwitchIntent","name":"Roteia por intent","type":"n8n-nodes-base.switch","typeVersion":1,"position":[1760,420],"parameters":{"value1":"={{$json.intent}}","rules":[{"operation":"equal","value2":"agendar"},{"operation":"equal","value2":"cancelar"},{"operation":"equal","value2":"remarcar"},{"operation":"equal","value2":"outro"}]}},{"id":"ApiServices","name":"API Services","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2020,300],"parameters":{"url":"http://barberbook-api:8080/api/services","method":"GET","jsonParameters":false,"options":{}}},{"id":"GeminiResolveService","name":"Gemini Resolve Service","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2280,300],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Selecione o melhor serviÃ§o a partir da LISTA e do TEXTO do cliente.\\nResponda APENAS JSON: {\\\"matchName\\\":string|null}.\\nLISTA: {{JSON.stringify($prevNode['API Services'].json)}}\\nTEXTO: {{$json.service || $json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"MergeAg","name":"Merge Services+AI","type":"n8n-nodes-base.merge","typeVersion":1,"position":[2540,300],"parameters":{"mode":"mergeByPosition"}},{"id":"MapServiceId","name":"Map Service Id","type":"n8n-nodes-base.function","typeVersion":1,"position":[2800,300],"parameters":{"functionCode":"const items=$input.all();function normalize(s){return String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s]/g,'').trim();}return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let matchName=null;const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{const parsed=JSON.parse(m[0]);matchName=(parsed&&typeof parsed==='object')?parsed.matchName:null;}catch(e){matchName=null;}}else{try{const parsed=JSON.parse(t);matchName=(parsed&&typeof parsed==='object')?parsed.matchName:null;}catch(e){matchName=null;}}let servicesArr=[];const candidates=[];const scan=(o)=>{if(!o||typeof o!=='object')return;for(const [k,v] of Object.entries(o)){if(Array.isArray(v)&&v.length&&v.every(e=>typeof e==='object')){const score=v.filter(e=>('name'in e)||('serviceName'in e)||('title'in e)||('displayName'in e)).length; if(score>0){candidates.push({k,v,score});}}}};scan(j);candidates.sort((a,b)=>b.score-a.score);if(candidates[0])servicesArr=candidates[0].v;const names=servicesArr.map(o=>({id:o.id??o.serviceId??o._id??o.uuid??o.key??o.code??null,name:o.name??o.serviceName??o.title??o.displayName??null})).filter(o=>o.id!=null&&o.name!=null);const optionsText=names.map(n=>n.name).join(', ');let serviceId=null,serviceName=null;if(matchName){const nMatch=normalize(matchName);let found=names.find(n=>normalize(n.name)===nMatch);if(!found)found=names.find(n=>normalize(n.name).includes(nMatch)||nMatch.includes(normalize(n.name)));if(found){serviceId=found.id;serviceName=found.name;}}return {json:{...j,serviceId,serviceName,serviceOptionsText:optionsText}};"}},{"id":"IfServiceFound","name":"service ok?","type":"n8n-nodes-base.if","typeVersion":1,"position":[3060,300],"parameters":{"conditions":{"string":[{"value1":"={{$json.serviceId + ''}}","operation":"isNotEmpty"}]}}},{"id":"WahaNotFound","name":"WAHA ServiÃ§o nÃ£o encontrado","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3320,260],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"NÃ£o encontrei esse serviÃ§o. OpÃ§Ãµes: {{$json.serviceOptionsText}}\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"GeminiNormalizeDate","name":"Gemini Normalize Date","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3320,340],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Converta a expressÃ£o de data em PT-BR para YYYY-MM-DD. Hoje/amanhÃ£/nomes de dias.\\nResponda APENAS JSON: {\\\"date\\\":\\\"YYYY-MM-DD\\\"}.\\nEntrada: {{$json.date || $json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ApplyDate","name":"Apply Date","type":"n8n-nodes-base.function","typeVersion":1,"position":[3580,340],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let date=null;const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{const parsed=JSON.parse(m[0]);date=parsed?.date??null;}catch(e){date=null;}}else{try{const parsed=JSON.parse(t);date=parsed?.date??null;}catch(e){date=null;}}const ok=typeof date==='string' && /^\d{4}-\d{2}-\d{2}$/.test(date);return {json:{...j,date: ok?date:j.date,validDate: ok}};"}},{"id":"IfDateValid","name":"data vÃ¡lida?","type":"n8n-nodes-base.if","typeVersion":1,"position":[3840,340],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.validDate}}","value2":true}]}}},{"id":"ApiSlots","name":"API Slots","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[4100,340],"parameters":{"url":"=http://barberbook-api:8080/api/slots?serviceId={{$json.serviceId}}&date={{$json.date}}","method":"GET","jsonParameters":false,"options":{}}},{"id":"FormatSlots","name":"Format Slots","type":"n8n-nodes-base.function","typeVersion":1,"position":[4360,340],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let arr=[];if(Array.isArray(j)) arr=j; else {for(const [k,v] of Object.entries(j)){if(Array.isArray(v)){arr=v;break;}}}const take=(arr||[]).filter(x=>x&&(x.startUtc||x.start||x.start_time||x.startISO)).slice(0,5);const toHHmm=(iso)=>{const d=new Date(iso);return isNaN(d)?String(iso):d.toISOString().slice(11,16)};const slots=take.map(x=>{const su=x.startUtc||x.start||x.start_time||x.startISO;const eu=x.endUtc||x.end||x.end_time||x.endISO||null;return {startUtc:su,endUtc:eu,display:toHHmm(su)};});const hasSlots=slots.length>0;const listText=hasSlots?slots.map((s,i)=>`${i+1}) ${s.display}`).join('\\n'):'';return {json:{...j,slots,hasSlots,listText}};"}},{"id":"IfHasSlots","name":"tem slots?","type":"n8n-nodes-base.if","typeVersion":1,"position":[4620,340],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.hasSlots}}","value2":true}]}}},{"id":"WahaNoSlots","name":"WAHA Sem horÃ¡rios","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[4880,320],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Sem horÃ¡rios nesse dia. Quer tentar outra data?\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"RedisSave","name":"Redis Save State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[4880,360],"parameters":{"command":"set","key":"=state:{{$json.chatId}}","value":"={{JSON.stringify({serviceId:$json.serviceId,serviceName:$json.serviceName,date:$json.date,slots:$json.slots})}}"}},{"id":"RedisExpire","name":"Redis Expire State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[5140,360],"parameters":{"command":"expire","key":"=state:{{$json.chatId}}","ttl":1800}},{"id":"WahaLista","name":"WAHA Lista","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[5400,360],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Escolha uma opÃ§Ã£o:\\\\n{{$json.listText}}\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"WahaInvalidDate","name":"WAHA Data invÃ¡lida","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[4100,320],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Formato invÃ¡lido. Use YYYY-MM-DD.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ExtractIdOrTimeCancel","name":"Extract IdOrTime (cancel)","type":"n8n-nodes-base.function","typeVersion":1,"position":[2020,420],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};const text=String(j.text||'');const uuid=text.match(/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/);let appointmentId=uuid?uuid[0].toLowerCase():null;let time=null;if(!appointmentId){const m=text.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/);time=m?m[0]:null;}const hasKey=Boolean(appointmentId||time);return {json:{...j,appointmentId,time,hasKey}};"}},{"id":"IfHasIdOrTimeCancel","name":"tem id/time? (cancel)","type":"n8n-nodes-base.if","typeVersion":1,"position":[2280,420],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.hasKey}}","value2":true}]}}},{"id":"WahaAskIdTimeCancel","name":"WAHA Ask Id/Time (cancel)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2540,400],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Envie o cÃ³digo/horÃ¡rio.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ApiCancel2","name":"API Cancel","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2540,460],"parameters":{"url":"http://barberbook-api:8080/api/cancel","method":"POST","jsonParameters":true,"options":{"fullResponse":true},"headerParametersJson":"={\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"appointmentId\":\"{{$json.appointmentId || ''}}\",\"reason\":\"Solicitado via WhatsApp\"}"}},{"id":"IfCancelOK","name":"status 200?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2800,460],"parameters":{"conditions":{"number":[{"value1":"={{$json.statusCode}}","operation":"equal","value2":200}]}}},{"id":"WahaCancelOK","name":"WAHA Cancelado","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3060,440],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Cancelado âœ…\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"WahaCancelFail","name":"WAHA Cancel Falha","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3060,500],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"NÃ£o consegui cancelar...\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"IfDateEmptyR","name":"Date vazia?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2020,540],"parameters":{"conditions":{"string":[{"value1":"={{$json.date}}","operation":"isEmpty"}]}}},{"id":"WahaAskDateR","name":"WAHA Pergunta Data (R)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2280,540],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Qual a nova data? (YYYY-MM-DD)\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"GeminiNormalizeDateR","name":"Gemini Normalize Date (R)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2540,540],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Converta a expressÃ£o de data em PT-BR para YYYY-MM-DD. Hoje/amanhÃ£/nomes de dias.\\nResponda APENAS JSON: {\\\"date\\\":\\\"YYYY-MM-DD\\\"}.\\nEntrada: {{$json.date || $json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ApplyDateR","name":"Apply Date (R)","type":"n8n-nodes-base.function","typeVersion":1,"position":[2800,540],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let date=null;const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{const parsed=JSON.parse(m[0]);date=parsed?.date??null;}catch(e){date=null;}}else{try{const parsed=JSON.parse(t);date=parsed?.date??null;}catch(e){date=null;}}const ok=typeof date==='string' && /^\d{4}-\d{2}-\d{2}$/.test(date);return {json:{...j,date: ok?date:j.date,validDateR: ok}};"}},{"id":"ApiSlotsR","name":"API Slots (R)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3060,540],"parameters":{"url":"=http://barberbook-api:8080/api/slots?serviceId={{$json.serviceId || ''}}&date={{$json.date}}","method":"GET","jsonParameters":false,"options":{}}},{"id":"WahaAskServiceR","name":"WAHA Pergunta ServiÃ§o (R)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3060,500],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Qual serviÃ§o? (ex.: corte, barba)\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyOutro","name":"WAHA Reply outro","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2020,660],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"outro...\"}"}},{"id":"RespondOK","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[5700,400],"parameters":{"responseFormat":"string","responseBody":"OK","responseCode":200}}],"connections":{"Webhook":{"main":[[{"node":"Parse WAHA","type":"main","index":0}]]},"Parse WAHA":{"main":[[{"node":"fromMe?","type":"main","index":0},{"node":"Merge WAHA+AI","type":"main","index":0}]]},"fromMe?":{"main":[[{"node":"WAHA Seen","type":"main","index":0}],[{"node":"Redis Load State","type":"main","index":0}]]},"WAHA Seen":{"main":[[{"node":"Respond OK (fromMe)","type":"main","index":0}]]},"Redis Load State":{"main":[[{"node":"Tem State?","type":"main","index":0}]]},"Tem State?":{"main":[[{"node":"Pick Option","type":"main","index":0}],[{"node":"Gemini Intent","type":"main","index":0}]]},"Pick Option":{"main":[[{"node":"opÃ§Ã£o vÃ¡lida?","type":"main","index":0}]]},"opÃ§Ã£o vÃ¡lida?":{"main":[[{"node":"API Book","type":"main","index":0}],[{"node":"WAHA OpÃ§Ã£o invÃ¡lida","type":"main","index":0}]]},"WAHA OpÃ§Ã£o invÃ¡lida":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"API Book":{"main":[[{"node":"conflito?","type":"main","index":0}]]},"conflito?":{"main":[[{"node":"WAHA Conflito","type":"main","index":0}],[{"node":"WAHA Confirmado","type":"main","index":0}]]},"WAHA Conflito":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Confirmado":{"main":[[{"node":"Redis Clear State","type":"main","index":0}]]},"Redis Clear State":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Gemini Intent":{"main":[[{"node":"Parse AI","type":"main","index":0}]]},"Parse AI":{"main":[[{"node":"Merge WAHA+AI","type":"main","index":1}]]},"Merge WAHA+AI":{"main":[[{"node":"Roteia por intent","type":"main","index":0}]]},"Roteia por intent":{"main":[[{"node":"API Services","type":"main","index":0}],[{"node":"Extract IdOrTime (cancel)","type":"main","index":0}],[{"node":"Date vazia?","type":"main","index":0}],[{"node":"WAHA Reply outro","type":"main","index":0}]]},"API Services":{"main":[[{"node":"Gemini Resolve Service","type":"main","index":0},{"node":"Merge Services+AI","type":"main","index":1}]]},"Gemini Resolve Service":{"main":[[{"node":"Merge Services+AI","type":"main","index":0}]]},"Merge Services+AI":{"main":[[{"node":"Map Service Id","type":"main","index":0}]]},"Map Service Id":{"main":[[{"node":"service ok?","type":"main","index":0}]]},"service ok?":{"main":[[{"node":"Gemini Normalize Date","type":"main","index":0}],[{"node":"WAHA ServiÃ§o nÃ£o encontrado","type":"main","index":0}]]},"WAHA ServiÃ§o nÃ£o encontrado":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Gemini Normalize Date":{"main":[[{"node":"Apply Date","type":"main","index":0}]]},"Apply Date":{"main":[[{"node":"data vÃ¡lida?","type":"main","index":0}]]},"data vÃ¡lida?":{"main":[[{"node":"API Slots","type":"main","index":0}],[{"node":"WAHA Data invÃ¡lida","type":"main","index":0}]]},"API Slots":{"main":[[{"node":"Format Slots","type":"main","index":0}]]},"Format Slots":{"main":[[{"node":"tem slots?","type":"main","index":0}]]},"tem slots?":{"main":[[{"node":"Redis Save State","type":"main","index":0}],[{"node":"WAHA Sem horÃ¡rios","type":"main","index":0}]]},"WAHA Sem horÃ¡rios":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Redis Save State":{"main":[[{"node":"Redis Expire State","type":"main","index":0}]]},"Redis Expire State":{"main":[[{"node":"WAHA Lista","type":"main","index":0}]]},"WAHA Lista":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Data invÃ¡lida":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Extract IdOrTime (cancel)":{"main":[[{"node":"tem id/time? (cancel)","type":"main","index":0}]]},"tem id/time? (cancel)":{"main":[[{"node":"API Cancel","type":"main","index":0}],[{"node":"WAHA Ask Id/Time (cancel)","type":"main","index":0}]]},"WAHA Ask Id/Time (cancel)":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"API Cancel":{"main":[[{"node":"status 200?","type":"main","index":0}]]},"status 200?":{"main":[[{"node":"WAHA Cancelado","type":"main","index":0}],[{"node":"WAHA Cancel Falha","type":"main","index":0}]]},"WAHA Cancelado":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Cancel Falha":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Date vazia?":{"main":[[{"node":"WAHA Pergunta Data (R)","type":"main","index":0}],[{"node":"Gemini Normalize Date (R)","type":"main","index":0}]]},"WAHA Pergunta Data (R)":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Gemini Normalize Date (R)":{"main":[[{"node":"Apply Date (R)","type":"main","index":0}]]},"Apply Date (R)":{"main":[[{"node":"API Slots (R)","type":"main","index":0}]]},"WAHA Pergunta ServiÃ§o (R)":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply outro":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}},"active":false,"settings":{},"staticData":{}}

