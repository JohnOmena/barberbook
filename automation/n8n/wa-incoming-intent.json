{"name":"wa-incoming (intent)","nodes":[{"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[260,300],"parameters":{"path":"wa-incoming","httpMethod":"POST","responseMode":"responseNode"}},{"id":"FunctionParse","name":"Parse WAHA","type":"n8n-nodes-base.function","typeVersion":1,"position":[520,300],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const r=item.json||{};const b=(r.body??r.data??r.payload??r.message??r.msg??{});const p=(b.payload??b.message??b.msg??r.payload??{});const chatId=(b.chatId??p.chatId??p.from??b.from??(b.key?.remoteJid)??(p.key?.remoteJid)??'');let text=(b.text??b.body??b.message?.text??b.message?.conversation??b.messages?.[0]?.text?.body??p.text??p.body??r.text??'');text=(typeof text==='string'?text.trim():(text!=null?JSON.stringify(text):''));const fromMe=Boolean(p.fromMe??b.fromMe??r.fromMe??false);const pushName=(r.me?.pushName??b.me?.pushName??p.me?.pushName??r.pushName??b.pushName??p.pushName??'')||'';const messageId=(p.id??b.id??b.key?.id??p.key?.id??'');return {json:{chatId,text,fromMe,pushName,messageId,session:'default'}};});"}},{"id":"IFNode","name":"fromMe?","type":"n8n-nodes-base.if","typeVersion":1,"position":[780,300],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.fromMe}}","value2":true}]}}},{"id":"WAHASeen","name":"WAHA Seen","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1040,200],"parameters":{"url":"http://waha:3000/api/sendSeen","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\"}"}},{"id":"RespondFromMe","name":"Respond OK (fromMe)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1300,200],"parameters":{"responseFormat":"string","responseBody":"OK (fromMe)","responseCode":200}},{"id":"GeminiIntent","name":"Gemini Intent","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1040,420],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Classifique a intenção desta mensagem de WhatsApp em PT-BR.\\nResponda APENAS JSON com: {\\\"intent\\\":\\\"agendar|cancelar|remarcar|outro\\\",\\\"service\\\":string|null,\\\"date\\\":YYYY-MM-DD|null}.\\nMensagem: {{$json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ParseAI","name":"Parse AI","type":"n8n-nodes-base.function","typeVersion":1,"position":[1300,420],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let parsed={};const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{parsed=JSON.parse(m[0]);}catch(e){parsed={};}}else{try{parsed=JSON.parse(t);}catch(e){parsed={};}}let intent=parsed.intent;const intents=['agendar','cancelar','remarcar','outro'];if(!intents.includes(intent))intent='outro';const service=(parsed.service===null||typeof parsed.service==='string')?parsed.service:null;let date=parsed.date??null;if(typeof date==='string'){const mm=date.match(/^(\d{4}-\d{2}-\d{2})/);date=mm?mm[1]:null;}else{date=null;}return {json:{intent,service,date}};});"}},{"id":"MergeWAHA","name":"Merge WAHA+AI","type":"n8n-nodes-base.merge","typeVersion":1,"position":[1560,420],"parameters":{"mode":"mergeByPosition"}},{"id":"SwitchIntent","name":"Roteia por intent","type":"n8n-nodes-base.switch","typeVersion":1,"position":[1820,420],"parameters":{"value1":"={{$json.intent}}","rules":[{"operation":"equal","value2":"agendar"},{"operation":"equal","value2":"cancelar"},{"operation":"equal","value2":"remarcar"},{"operation":"equal","value2":"outro"}]}},{"id":"ReplyAgendar","name":"WAHA Reply agendar","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,300],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Ok, vamos agendar. Diga o serviço (ex.: corte, barba, cabelo e barba).\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyCancelar","name":"WAHA Reply cancelar","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,420],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Ok, vamos cancelar. Me diga o código/horário do agendamento.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyRemarcar","name":"WAHA Reply remarcar","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,540],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Ok, vamos remarcar. Qual a nova data (YYYY-MM-DD)?\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyOutro","name":"WAHA Reply outro","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,660],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Posso ajudar com agendar, cancelar ou remarcar.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"RespondOK","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[2340,480],"parameters":{"responseFormat":"string","responseBody":"OK","responseCode":200}}],"connections":{"Webhook":{"main":[[{"node":"Parse WAHA","type":"main","index":0}]]},"Parse WAHA":{"main":[[{"node":"fromMe?","type":"main","index":0},{"node":"Merge WAHA+AI","type":"main","index":0}]]},"fromMe?":{"main":[[{"node":"WAHA Seen","type":"main","index":0}],[{"node":"Gemini Intent","type":"main","index":0}]]},"WAHA Seen":{"main":[[{"node":"Respond OK (fromMe)","type":"main","index":0}]]},"Gemini Intent":{"main":[[{"node":"Parse AI","type":"main","index":0}]]},"Parse AI":{"main":[[{"node":"Merge WAHA+AI","type":"main","index":1}]]},"Merge WAHA+AI":{"main":[[{"node":"Roteia por intent","type":"main","index":0}]]},"Roteia por intent":{"main":[[{"node":"WAHA Reply agendar","type":"main","index":0}],[{"node":"WAHA Reply cancelar","type":"main","index":0}],[{"node":"WAHA Reply remarcar","type":"main","index":0}],[{"node":"WAHA Reply outro","type":"main","index":0}]]},"WAHA Reply agendar":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply cancelar":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply remarcar":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply outro":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}},"active":false,"settings":{},"staticData":{}}
