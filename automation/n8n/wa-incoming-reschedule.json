{"name":"wa-incoming (reschedule)","nodes":[{"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[260,300],"parameters":{"path":"wa-incoming","httpMethod":"POST","responseMode":"responseNode"}},{"id":"FunctionParse","name":"Parse WAHA","type":"n8n-nodes-base.function","typeVersion":1,"position":[520,300],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const r=item.json||{};const b=(r.body??r.data??r.payload??r.message??r.msg??{});const p=(b.payload??b.message??b.msg??r.payload??{});const chatId=(b.chatId??p.chatId??p.from??b.from??(b.key?.remoteJid)??(p.key?.remoteJid)??'');let text=(b.text??b.body??b.message?.text??b.message?.conversation??b.messages?.[0]?.text?.body??p.text??p.body??r.text??'');text=(typeof text==='string'?text.trim():(text!=null?JSON.stringify(text):''));const fromMe=Boolean(p.fromMe??b.fromMe??r.fromMe??false);const pushName=(r.me?.pushName??b.me?.pushName??p.me?.pushName??r.pushName??b.pushName??p.pushName??'')||'';const messageId=(p.id??b.id??b.key?.id??p.key?.id??'');return {json:{chatId,text,fromMe,pushName,messageId,session:'default'}};});"}},{"id":"IFNode","name":"fromMe?","type":"n8n-nodes-base.if","typeVersion":1,"position":[780,300],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.fromMe}}","value2":true}]}}},{"id":"WAHASeen","name":"WAHA Seen","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1040,200],"parameters":{"url":"http://waha:3000/api/sendSeen","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\"}"}},{"id":"RespondFromMe","name":"Respond OK (fromMe)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1300,200],"parameters":{"responseFormat":"string","responseBody":"OK (fromMe)","responseCode":200}},{"id":"RedisLoadRemState","name":"Redis Load Remarcar State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1040,360],"parameters":{"command":"get","key":"=state:{{$json.chatId}}:remarcar"}},{"id":"MergeRemWAHA","name":"Merge WAHA+RemState","type":"n8n-nodes-base.merge","typeVersion":1,"position":[1300,360],"parameters":{"mode":"mergeByPosition"}},{"id":"ParseRemState","name":"Parse Remarcar State","type":"n8n-nodes-base.function","typeVersion":1,"position":[1560,360],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let raw=(j.value??j.data??j.state??null);let remState=null;let rawStr='';if(raw!=null){if(typeof raw==='string'){rawStr=raw;try{remState=JSON.parse(raw);}catch(e){remState=null;}}else if(typeof raw==='object'){remState=raw;rawStr=JSON.stringify(raw);}}return {json:{...j,remState,_remStateRaw:rawStr}};});"}},{"id":"IfHasRemState","name":"tem remState?","type":"n8n-nodes-base.if","typeVersion":1,"position":[1820,360],"parameters":{"conditions":{"string":[{"value1":"={{$json._remStateRaw}}","operation":"isNotEmpty"}]}}},{"id":"PickOptionRem","name":"Pick Option (remarcar)","type":"n8n-nodes-base.function","typeVersion":1,"position":[2080,360],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};const txt=String(j.text||'');const m=txt.match(/\d+/);const n=m?parseInt(m[0],10):NaN;const st=j.remState||{};const slots=Array.isArray(st.slots)?st.slots:[];let optionValid=false,selectedStartUtc=null;let serviceId=j.serviceId??st.serviceId??null;let serviceName=j.serviceName??st.serviceName??null;let date=j.date??st.date??null; if(Number.isInteger(n)&&n>=1&&n<=5&&n<=slots.length){selectedStartUtc=slots[n-1]?.startUtc??null;optionValid=Boolean(selectedStartUtc);}return {json:{...j,optionValid,selectedStartUtc,serviceId,serviceName,date}};});"}},{"id":"IfOptionValidRem","name":"opção válida? (remarcar)","type":"n8n-nodes-base.if","typeVersion":1,"position":[2340,360],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.optionValid}}","value2":true}]}}},{"id":"WahaInvalidOptionRem","name":"WAHA Opção inválida (remarcar)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2620,340],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Opção inválida. Envie um número da lista.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ApiBookRem","name":"API Book (remarcar)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2620,420],"parameters":{"url":"http://barberbook-api:8080/api/book","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"serviceId\":\"{{$json.serviceId}}\",\"startUtc\":\"{{$json.selectedStartUtc}}\",\"clientName\":\"{{$json.pushName || 'Cliente'}}\",\"clientContact\":\"{{$json.chatId}}\"}"}},{"id":"WahaRemarcado","name":"WAHA Remarcado","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2900,420],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Remarcado ✅: {{$json.selectedStartUtc}} (UTC).\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"RedisClearRem","name":"Redis Clear Remarcar State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[3180,420],"parameters":{"command":"del","key":"=state:{{$json.chatId}}:remarcar"}},{"id":"RespondOK","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[3460,420],"parameters":{"responseFormat":"string","responseBody":"OK","responseCode":200}},{"id":"GeminiIntent","name":"Gemini Intent","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1040,440],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Classifique a intenção desta mensagem de WhatsApp em PT-BR.\\nResponda APENAS JSON com: {\\\"intent\\\":\\\"agendar|cancelar|remarcar|outro\\\",\\\"service\\\":string|null,\\\"date\\\":YYYY-MM-DD|null}.\\nMensagem: {{$json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ParseAI","name":"Parse AI","type":"n8n-nodes-base.function","typeVersion":1,"position":[1300,440],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let parsed={};const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{parsed=JSON.parse(m[0]);}catch(e){parsed={};}}else{try{parsed=JSON.parse(t);}catch(e){parsed={};}}let intent=parsed.intent;const intents=['agendar','cancelar','remarcar','outro'];if(!intents.includes(intent))intent='outro';const service=(parsed.service===null||typeof parsed.service==='string')?parsed.service:null;let date=parsed.date??null;if(typeof date==='string'){const mm=date.match(/^(\d{4}-\d{2}-\d{2})/);date=mm?mm[1]:null;}else{date=null;}return {json:{...j,intent,service,date}};});"}},{"id":"MergeWAHA","name":"Merge WAHA+AI","type":"n8n-nodes-base.merge","typeVersion":1,"position":[1560,440],"parameters":{"mode":"mergeByPosition"}},{"id":"SwitchIntent","name":"Roteia por intent","type":"n8n-nodes-base.switch","typeVersion":1,"position":[1820,440],"parameters":{"value1":"={{$json.intent}}","rules":[{"operation":"equal","value2":"agendar"},{"operation":"equal","value2":"cancelar"},{"operation":"equal","value2":"remarcar"},{"operation":"equal","value2":"outro"}]}},{"id":"ReplyAgendar","name":"WAHA Reply agendar","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,360],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Ok, vamos agendar. Diga o serviço (ex.: corte, barba, cabelo e barba).\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyCancelar","name":"WAHA Reply cancelar","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,440],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Ok, vamos cancelar. Me diga o código/horário do agendamento.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyOutro","name":"WAHA Reply outro","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,520],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Posso ajudar com agendar, cancelar ou remarcar.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"IfDateMissingRem","name":"Date missing? (remarcar)","type":"n8n-nodes-base.if","typeVersion":1,"position":[2080,600],"parameters":{"conditions":{"string":[{"value1":"={{$json.date + ''}}","operation":"isEmpty"}]}}},{"id":"WahaAskNewDate","name":"WAHA Ask New Date","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2340,600],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Qual nova data? (YYYY-MM-DD)\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"GeminiNormRem","name":"Gemini Normalize Date (remarcar)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2340,700],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Converta a expressão de data em PT-BR para YYYY-MM-DD. Hoje/amanhã/nomes de dias.\\nResponda APENAS JSON: {\\\"date\\\":\\\"YYYY-MM-DD\\\"}.\\nEntrada: {{$json.date || $json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"MergeDateRem","name":"Merge Date WAHA (remarcar)","type":"n8n-nodes-base.merge","typeVersion":1,"position":[2600,700],"parameters":{"mode":"mergeByPosition"}},{"id":"ApplyDateRem","name":"Apply Date (remarcar)","type":"n8n-nodes-base.function","typeVersion":1,"position":[2860,700],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let date=null;const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{const parsed=JSON.parse(m[0]);date=parsed?.date??null;}catch(e){date=null;}}else{try{const parsed=JSON.parse(t);date=parsed?.date??null;}catch(e){date=null;}}const ok=typeof date==='string' && /^\d{4}-\d{2}-\d{2}$/.test(date);return {json:{...j,date: ok?date:j.date,validDateRem: ok}};});"}},{"id":"IfDateValidRem","name":"Date valid? (remarcar)","type":"n8n-nodes-base.if","typeVersion":1,"position":[3120,700],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.validDateRem}}","value2":true}]}}},{"id":"WahaInvalidDateRem","name":"WAHA Invalid Date (remarcar)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3380,760],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Formato inválido. Use YYYY-MM-DD.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ApiSlotsRem","name":"API Slots (remarcar)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3380,680],"parameters":{"url":"=http://barberbook-api:8080/api/slots?serviceId={{$json.serviceId || '<coloque-id-padrão-ou-pergunte-serviço>'}}&date={{$json.date}}","method":"GET","jsonParameters":false,"options":{}}},{"id":"FmtSlotsRem","name":"Format Slots (remarcar)","type":"n8n-nodes-base.function","typeVersion":1,"position":[3640,680],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let arr=[];const search=(o)=>{if(!o||typeof o!=='object')return;for(const [k,v] of Object.entries(o)){if(Array.isArray(v)&&v.length&&v.every(e=>typeof e==='object'&&('startUtc'in e||'start'in e))){arr=v;}}};search(j);const slots=arr.slice(0,5).map(x=>({startUtc:x.startUtc??x.start??null})).filter(x=>x.startUtc);const lines=slots.map((s,i)=>`${i+1}) ${s.startUtc} (UTC)`).join('\n');const msg=slots.length?`Opções de horários:\n${lines}\nResponda com 1..${slots.length}.`:'Sem opções disponíveis para esta data.';const stateRemarcar={serviceId:j.serviceId??null,serviceName:j.serviceName??null,date:j.date??null,slots};return {json:{...j,slotsMsg:msg,stateRemarcar}};});"}},{"id":"WahaSlotsRem","name":"WAHA Slots (remarcar)","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3900,680],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"{{$json.slotsMsg}}\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"RedisSaveRem","name":"Redis Save Remarcar State","type":"n8n-nodes-base.redis","typeVersion":1,"position":[4160,680],"parameters":{"command":"set","key":"=state:{{$json.chatId}}:remarcar","value":"={{JSON.stringify($json.stateRemarcar)}}"}}],"connections":{"Webhook":{"main":[[{"node":"Parse WAHA","type":"main","index":0}]]},"Parse WAHA":{"main":[[{"node":"fromMe?","type":"main","index":0},{"node":"Merge WAHA+RemState","type":"main","index":0},{"node":"Merge WAHA+AI","type":"main","index":0}]]},"fromMe?":{"main":[[{"node":"WAHA Seen","type":"main","index":0}],[{"node":"Redis Load Remarcar State","type":"main","index":0}]]},"WAHA Seen":{"main":[[{"node":"Respond OK (fromMe)","type":"main","index":0}]]},"Redis Load Remarcar State":{"main":[[{"node":"Merge WAHA+RemState","type":"main","index":1}]]},"Merge WAHA+RemState":{"main":[[{"node":"Parse Remarcar State","type":"main","index":0}]]},"Parse Remarcar State":{"main":[[{"node":"tem remState?","type":"main","index":0}]]},"tem remState?":{"main":[[{"node":"Pick Option (remarcar)","type":"main","index":0}],[{"node":"Gemini Intent","type":"main","index":0}]]},"Pick Option (remarcar)":{"main":[[{"node":"opção válida? (remarcar)","type":"main","index":0}]]},"opção válida? (remarcar)":{"main":[[{"node":"API Book (remarcar)","type":"main","index":0}],[{"node":"WAHA Opção inválida (remarcar)","type":"main","index":0}]]},"WAHA Opção inválida (remarcar)":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"API Book (remarcar)":{"main":[[{"node":"WAHA Remarcado","type":"main","index":0}]]},"WAHA Remarcado":{"main":[[{"node":"Redis Clear Remarcar State","type":"main","index":0}]]},"Redis Clear Remarcar State":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Gemini Intent":{"main":[[{"node":"Parse AI","type":"main","index":0}]]},"Parse AI":{"main":[[{"node":"Merge WAHA+AI","type":"main","index":1}]]},"Merge WAHA+AI":{"main":[[{"node":"Roteia por intent","type":"main","index":0}]]},"Roteia por intent":{"main":[[{"node":"WAHA Reply agendar","type":"main","index":0}],[{"node":"WAHA Reply cancelar","type":"main","index":0}],[{"node":"Date missing? (remarcar)","type":"main","index":0}],[{"node":"WAHA Reply outro","type":"main","index":0}]]},"WAHA Reply agendar":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply cancelar":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply outro":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Date missing? (remarcar)":{"main":[[{"node":"WAHA Ask New Date","type":"main","index":0}],[{"node":"Gemini Normalize Date (remarcar)","type":"main","index":0},{"node":"Merge Date WAHA (remarcar)","type":"main","index":1}]]},"WAHA Ask New Date":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Gemini Normalize Date (remarcar)":{"main":[[{"node":"Merge Date WAHA (remarcar)","type":"main","index":0}]]},"Merge Date WAHA (remarcar)":{"main":[[{"node":"Apply Date (remarcar)","type":"main","index":0}]]},"Apply Date (remarcar)":{"main":[[{"node":"Date valid? (remarcar)","type":"main","index":0}]]},"Date valid? (remarcar)":{"main":[[{"node":"API Slots (remarcar)","type":"main","index":0}],[{"node":"WAHA Invalid Date (remarcar)","type":"main","index":0}]]},"WAHA Invalid Date (remarcar)":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"API Slots (remarcar)":{"main":[[{"node":"Format Slots (remarcar)","type":"main","index":0}]]},"Format Slots (remarcar)":{"main":[[{"node":"WAHA Slots (remarcar)","type":"main","index":0}]]},"WAHA Slots (remarcar)":{"main":[[{"node":"Redis Save Remarcar State","type":"main","index":0}]]},"Redis Save Remarcar State":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}},"active":false,"settings":{},"staticData":{}}
