{"name":"wa-incoming (final)","nodes":[{"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[200,300],"parameters":{"path":"wa-incoming","httpMethod":"POST","responseMode":"responseNode"}},{"id":"ParseWAHA","name":"Parse_WAHA","type":"n8n-nodes-base.function","typeVersion":1,"position":[460,300],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};const b=(j.body??j.data??j.payload??j.message??j.msg??{});const p=(b.payload??b.message??b.msg??j.payload??{});const chatId=(b.chatId??p.chatId??p.from??b.from??(b.key?.remoteJid)??(p.key?.remoteJid)??'');let text=(b.text??b.body??b.message?.text??b.message?.conversation??b.messages?.[0]?.text?.body??p.text??p.body??j.text??'');text=(typeof text==='string'?text.trim():(text!=null?JSON.stringify(text):''));const fromMe=Boolean(p.fromMe??b.fromMe??j.fromMe??false);const pushName=(j.me?.pushName??b.me?.pushName??p.me?.pushName??j.pushName??b.pushName??p.pushName??'')||'';const messageId=(p.id??b.id??b.key?.id??p.key?.id??'');return {json:{chatId,text,fromMe,pushName,messageId,session:'default'}};});"}},{"id":"IfFromMe","name":"FromMe","type":"n8n-nodes-base.if","typeVersion":1,"position":[720,300],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.fromMe}}","value2":true}]}}},{"id":"WAHASeen","name":"WAHA_Seen","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[980,220],"parameters":{"url":"http://waha:3000/api/sendSeen","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\"}"}},{"id":"RespondFromMe","name":"Respond_OK_fromMe","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1240,220],"parameters":{"responseFormat":"string","responseBody":"OK (fromMe)","responseCode":200}},{"id":"LoadState","name":"LoadState","type":"n8n-nodes-base.redis","typeVersion":1,"position":[980,420],"parameters":{"command":"get","key":"=state:{{$json.chatId}}"}},{"id":"CarryBase","name":"Carry_Base","type":"n8n-nodes-base.function","typeVersion":1,"position":[980,540],"parameters":{"functionCode":"return items;"}},{"id":"MergeLoad","name":"Merge_Load","type":"n8n-nodes-base.merge","typeVersion":1,"position":[1240,480],"parameters":{"mode":"mergeByPosition"}},{"id":"ParseState","name":"Parse_State","type":"n8n-nodes-base.function","typeVersion":1,"position":[1500,480],"parameters":{"functionCode":"const items=$input.all();return items.map(it=>{const j=it.json||{};let state=null;try{if(typeof j.value==='string'&&j.value.trim())state=JSON.parse(j.value);}catch(e){}const statePresent=!!(state&&typeof state==='object');return {json:{...j,state,statePresent}};});"}},{"id":"IfHasState","name":"HasState","type":"n8n-nodes-base.if","typeVersion":1,"position":[1760,480],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.statePresent}}","value2":true}]}}},{"id":"PickOption","name":"PickOption","type":"n8n-nodes-base.function","typeVersion":1,"position":[2020,420],"parameters":{"functionCode":"const items=$input.all();return items.map(it=>{const j=it.json||{};const txt=String(j.text||'');const m=txt.match(/\d+/);const n=m?parseInt(m[0],10):NaN;const slots=Array.isArray(j.state?.slots)?j.state.slots:[];let optionValid=false;let selectedStartUtc=null;if(Number.isInteger(n)&&n>=1&&n<=slots.length){selectedStartUtc=slots[n-1]?.startUtc??null;optionValid=!!selectedStartUtc;}const serviceId=j.state?.serviceId??j.serviceId??null;const serviceName=j.state?.serviceName??j.serviceName??null;const date=j.state?.date??j.date??null;return {json:{...j,optionValid,selectedStartUtc,serviceId,serviceName,date}};});"}},{"id":"APIBook","name":"API_Book","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2280,420],"parameters":{"url":"http://barberbook-api:8080/api/book","method":"POST","jsonParameters":true,"options":{"fullResponse":true},"headerParametersJson":"={\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"serviceId\":\"{{$json.serviceId}}\",\"startUtc\":\"{{$json.selectedStartUtc}}\",\"clientName\":\"{{$json.pushName || 'Cliente'}}\",\"clientContact\":\"{{$json.chatId}}\"}"}},{"id":"IfConflict","name":"Conflict409","type":"n8n-nodes-base.if","typeVersion":1,"position":[2540,420],"parameters":{"conditions":{"number":[{"value1":"={{$json.statusCode}}","operation":"equal","value2":409}]}}},{"id":"WAHAConflict","name":"WAHA_Conflict","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2800,400],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"headerParametersJson":"={\"Content-Type\":\"application/json\"}","options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Esse horario esgotou agora. Quer ver outras opcoes?\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"WAHAConfirmed","name":"WAHA_Confirmed","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2800,460],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"headerParametersJson":"={\"Content-Type\":\"application/json\"}","options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Agendado: {{$json.serviceName}} em {{$json.selectedStartUtc}} (UTC).\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ClearState","name":"ClearState","type":"n8n-nodes-base.redis","typeVersion":1,"position":[3060,460],"parameters":{"command":"del","key":"=state:{{$json.chatId}}"}},{"id":"RespondOK","name":"Respond_OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[3320,420],"parameters":{"responseFormat":"string","responseBody":"OK","responseCode":200}},{"id":"GeminiIntent","name":"Gemini_Intent","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2020,560],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Classifique a intencao desta mensagem de WhatsApp em PT-BR.\\nResponda APENAS JSON com chaves: {\\\\\\\"intent\\\\\\\":\\\\\\\"agendar|cancelar|remarcar|outro\\\\\\\",\\\\\\\"service\\\\\\\":string|null,\\\\\\\"date\\\\\\\":YYYY-MM-DD|null}.\\nMensagem: {{$json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ParseAI","name":"Parse_AI","type":"n8n-nodes-base.function","typeVersion":1,"position":[2280,560],"parameters":{"functionCode":"const items=$input.all();return items.map(it=>{const j=it.json||{};let s='';try{const c=j.candidates||[];if(c[0]?.content?.parts?.[0]?.text!=null)s=c[0].content.parts[0].text;else if(j.content?.parts?.[0]?.text)s=j.content.parts[0].text;}catch(e){}let parsed={};const t=String(s||'').trim();try{parsed=JSON.parse(/\\{[\\s\\S]*\\}/.exec(t)?.[0]||t);}catch(e){parsed={};}let intent=parsed.intent;const intents=['agendar','cancelar','remarcar','outro'];if(!intents.includes(intent))intent='outro';const service=(parsed.service===null||typeof parsed.service==='string')?parsed.service:null;let date=parsed.date??null;if(typeof date==='string'){const m=date.match(/^(\\d{4}-\\d{2}-\\d{2})/);date=m?m[1]:null;}else date=null;return {json:{intent,service,date}});});"}},{"id":"CarryIA","name":"Carry_IA","type":"n8n-nodes-base.function","typeVersion":1,"position":[2020,640],"parameters":{"functionCode":"return items;"}},{"id":"MergeIA","name":"Merge_IA","type":"n8n-nodes-base.merge","typeVersion":1,"position":[2540,600],"parameters":{"mode":"mergeByPosition"}},{"id":"SwitchIntent","name":"Intent","type":"n8n-nodes-base.switch","typeVersion":1,"position":[2800,600],"parameters":{"value1":"={{$json.intent}}","rules":[{"operation":"equal","value2":"agendar"},{"operation":"equal","value2":"cancelar"},{"operation":"equal","value2":"remarcar"},{"operation":"equal","value2":"outro"}]}}],"connections":{"Webhook":{"main":[[{"node":"Parse_WAHA","type":"main","index":0}]]},"Parse_WAHA":{"main":[[{"node":"FromMe","type":"main","index":0}]]},"FromMe":{"main":[[{"node":"WAHA_Seen","type":"main","index":0}],[{"node":"LoadState","type":"main","index":0},{"node":"Carry_Base","type":"main","index":0}]]},"WAHA_Seen":{"main":[[{"node":"Respond_OK_fromMe","type":"main","index":0}]]},"LoadState":{"main":[[{"node":"Merge_Load","type":"main","index":1}]]},"Carry_Base":{"main":[[{"node":"Merge_Load","type":"main","index":0}]]},"Merge_Load":{"main":[[{"node":"Parse_State","type":"main","index":0}]]},"Parse_State":{"main":[[{"node":"HasState","type":"main","index":0}]]},"HasState":{"main":[[{"node":"PickOption","type":"main","index":0}],[{"node":"Gemini_Intent","type":"main","index":0},{"node":"Carry_IA","type":"main","index":0}]]},"PickOption":{"main":[[{"node":"API_Book","type":"main","index":0}]]},"API_Book":{"main":[[{"node":"Conflict409","type":"main","index":0}]]},"Conflict409":{"main":[[{"node":"WAHA_Conflict","type":"main","index":0}],[{"node":"WAHA_Confirmed","type":"main","index":0}]]},"WAHA_Confirmed":{"main":[[{"node":"ClearState","type":"main","index":0}]]},"WAHA_Conflict":{"main":[[{"node":"Respond_OK","type":"main","index":0}]]},"ClearState":{"main":[[{"node":"Respond_OK","type":"main","index":0}]]},"Gemini_Intent":{"main":[[{"node":"Parse_AI","type":"main","index":0}]]},"Parse_AI":{"main":[[{"node":"Merge_IA","type":"main","index":1}]]},"Carry_IA":{"main":[[{"node":"Merge_IA","type":"main","index":0}]]},"Merge_IA":{"main":[[{"node":"Intent","type":"main","index":0}]]}},"active":false,"settings":{},"staticData":{}}
