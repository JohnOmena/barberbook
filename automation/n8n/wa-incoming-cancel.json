{"name":"wa-incoming (cancel)","nodes":[{"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[260,300],"parameters":{"path":"wa-incoming","httpMethod":"POST","responseMode":"responseNode"}},{"id":"FunctionParse","name":"Parse WAHA","type":"n8n-nodes-base.function","typeVersion":1,"position":[520,300],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const r=item.json||{};const b=(r.body??r.data??r.payload??r.message??r.msg??{});const p=(b.payload??b.message??b.msg??r.payload??{});const chatId=(b.chatId??p.chatId??p.from??b.from??(b.key?.remoteJid)??(p.key?.remoteJid)??'');let text=(b.text??b.body??b.message?.text??b.message?.conversation??b.messages?.[0]?.text?.body??p.text??p.body??r.text??'');text=(typeof text==='string'?text.trim():(text!=null?JSON.stringify(text):''));const fromMe=Boolean(p.fromMe??b.fromMe??r.fromMe??false);const pushName=(r.me?.pushName??b.me?.pushName??p.me?.pushName??r.pushName??b.pushName??p.pushName??'')||'';const messageId=(p.id??b.id??b.key?.id??p.key?.id??'');return {json:{chatId,text,fromMe,pushName,messageId,session:'default'}};});"}},{"id":"IFNode","name":"fromMe?","type":"n8n-nodes-base.if","typeVersion":1,"position":[780,300],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.fromMe}}","value2":true}]}}},{"id":"WAHASeen","name":"WAHA Seen","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1040,200],"parameters":{"url":"http://waha:3000/api/sendSeen","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\"}"}},{"id":"RespondFromMe","name":"Respond OK (fromMe)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1300,200],"parameters":{"responseFormat":"string","responseBody":"OK (fromMe)","responseCode":200}},{"id":"GeminiIntent","name":"Gemini Intent","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[1040,420],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Classifique a intenção desta mensagem de WhatsApp em PT-BR.\\nResponda APENAS JSON com: {\\\"intent\\\":\\\"agendar|cancelar|remarcar|outro\\\",\\\"service\\\":string|null,\\\"date\\\":YYYY-MM-DD|null}.\\nMensagem: {{$json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"ParseAI","name":"Parse AI","type":"n8n-nodes-base.function","typeVersion":1,"position":[1300,420],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let parsed={};const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{parsed=JSON.parse(m[0]);}catch(e){parsed={};}}else{try{parsed=JSON.parse(t);}catch(e){parsed={};}}let intent=parsed.intent;const intents=['agendar','cancelar','remarcar','outro'];if(!intents.includes(intent))intent='outro';const service=(parsed.service===null||typeof parsed.service==='string')?parsed.service:null;let date=parsed.date??null;if(typeof date==='string'){const mm=date.match(/^(\d{4}-\d{2}-\d{2})/);date=mm?mm[1]:null;}else{date=null;}return {json:{intent,service,date}};});"}},{"id":"MergeWAHA","name":"Merge WAHA+AI","type":"n8n-nodes-base.merge","typeVersion":1,"position":[1560,420],"parameters":{"mode":"mergeByPosition"}},{"id":"SwitchIntent","name":"Roteia por intent","type":"n8n-nodes-base.switch","typeVersion":1,"position":[1820,420],"parameters":{"value1":"={{$json.intent}}","rules":[{"operation":"equal","value2":"agendar"},{"operation":"equal","value2":"cancelar"},{"operation":"equal","value2":"remarcar"},{"operation":"equal","value2":"outro"}]}},{"id":"ApiServices","name":"API Services","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,240],"parameters":{"url":"http://barberbook-api:8080/api/services","method":"GET","jsonParameters":false,"options":{}}},{"id":"GeminiResolveService","name":"Gemini Resolve Service","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2340,240],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\":[{\"text\":\"Selecione o melhor serviço a partir da LISTA e do TEXTO do cliente.\\nResponda APENAS JSON: {\\\"matchName\\\":string|null}.\\nLISTA: {{JSON.stringify($prevNode['API Services'].json)}}\\nTEXTO: {{$json.service || $json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"MergeAgWAHA","name":"Merge Ag WAHA+AI","type":"n8n-nodes-base.merge","typeVersion":1,"position":[2340,380],"parameters":{"mode":"mergeByPosition"}},{"id":"MergeAgAll","name":"Merge Ag All","type":"n8n-nodes-base.merge","typeVersion":1,"position":[2340,520],"parameters":{"mode":"mergeByPosition"}},{"id":"MapServiceId","name":"Map Service Id","type":"n8n-nodes-base.function","typeVersion":1,"position":[2340,660],"parameters":{"functionCode":"const items=$input.all();function normalize(s){return String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s]/g,'').trim();}return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let matchName=null;const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{const parsed=JSON.parse(m[0]);matchName=(parsed&&typeof parsed==='object')?parsed.matchName:null;}catch(e){matchName=null;}}else{try{const parsed=JSON.parse(t);matchName=(parsed&&typeof parsed==='object')?parsed.matchName:null;}catch(e){matchName=null;}}let servicesArr=[];const candidates=[];const scan=(o)=>{if(!o||typeof o!=='object')return;for(const [k,v] of Object.entries(o)){if(Array.isArray(v)&&v.length&&v.every(e=>typeof e==='object')){const score=v.filter(e=>('name'in e)||('serviceName'in e)||('title'in e)||('displayName'in e)).length; if(score>0){candidates.push({k,v,score});}}}};scan(j);candidates.sort((a,b)=>b.score-a.score);if(candidates[0])servicesArr=candidates[0].v;const names=servicesArr.map(o=>({id:o.id??o.serviceId??o._id??o.uuid??o.key??o.code??null,name:o.name??o.serviceName??o.title??o.displayName??null})).filter(o=>o.id!=null&&o.name!=null);const optionsText=names.map(n=>n.name).join(', ');let serviceId=null,serviceName=null;if(matchName){const nMatch=normalize(matchName);let found=names.find(n=>normalize(n.name)===nMatch);if(!found)found=names.find(n=>normalize(n.name).includes(nMatch)||nMatch.includes(normalize(n.name)));if(found){serviceId=found.id;serviceName=found.name;}}return {json:{...j,serviceId,serviceName,serviceOptionsText:optionsText}};"}},{"id":"IfServiceFound","name":"Service found?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2340,800],"parameters":{"conditions":{"string":[{"value1":"={{$json.serviceId + ''}}","operation":"isNotEmpty"}]}}},{"id":"WahaOpcoes","name":"WAHA Opções","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3060,820],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Não encontrei esse serviço. Opções: {{$json.serviceOptionsText}}\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"IfDateMissing","name":"Date missing?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2620,740],"parameters":{"conditions":{"string":[{"value1":"={{$json.date + ''}}","operation":"isEmpty"}]}}},{"id":"WahaAskDate","name":"WAHA Ask Date","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2900,740],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Serviço OK: {{$json.serviceName}}. Qual a data? (YYYY-MM-DD)\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"GeminiNormalizeDate","name":"Gemini Normalize Date","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2900,860],"parameters":{"url":"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent","method":"POST","jsonParameters":true,"options":{},"headerParametersJson":"={\"x-goog-api-key\":\"REPLACE_GEMINI_API_KEY\",\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"contents\":[{\"role\":\"user\",\"parts\")[{"text":"Converta a expressão de data em PT-BR para YYYY-MM-DD. Hoje/amanhã/nomes de dias.\\nResponda APENAS JSON: {\\\"date\\\":\\\"YYYY-MM-DD\\\"}.\\nEntrada: {{$json.date || $json.text}}\"}]}],\"generationConfig\":{\"responseMimeType\":\"application/json\"}}"}},{"id":"MergeDateWAHA","name":"Merge Date WAHA","type":"n8n-nodes-base.merge","typeVersion":1,"position":[3180,860],"parameters":{"mode":"mergeByPosition"}},{"id":"ApplyDate","name":"Apply Date","type":"n8n-nodes-base.function","typeVersion":1,"position":[3460,860],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};let s='';try{const c=j.candidates||[];if(c?.[0]?.content?.parts?.[0]?.text!=null){s=c[0].content.parts[0].text;}else if(j.content?.parts?.[0]?.text!=null){s=j.content.parts[0].text;}else{s='';}}catch(e){s='';}let date=null;const t=String(s||'').trim();const m=t.match(/\{[\s\S]*\}/);if(m){try{const parsed=JSON.parse(m[0]);date=parsed?.date??null;}catch(e){date=null;}}else{try{const parsed=JSON.parse(t);date=parsed?.date??null;}catch(e){date=null;}}const ok=typeof date==='string' && /^\d{4}-\d{2}-\d{2}$/.test(date);return {json:{...j,date: ok?date:j.date,validDate: ok}};});"}},{"id":"IfDateValid","name":"Date valid?","type":"n8n-nodes-base.if","typeVersion":1,"position":[3720,860],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.validDate}}","value2":true}]}}},{"id":"WahaInvalidDate","name":"WAHA Invalid Date","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3980,940],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Formato inválido. Use YYYY-MM-DD.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ExtractIdOrTime","name":"Extract IdOrTime","type":"n8n-nodes-base.function","typeVersion":1,"position":[2080,420],"parameters":{"functionCode":"const items=$input.all();return items.map(item=>{const j=item.json||{};const text=String(j.text||'');const uuid=text.match(/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/);let appointmentId=uuid?uuid[0].toLowerCase():null;let time=null;if(!appointmentId){const m=text.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/);time=m?m[0]:null;}const hasKey=Boolean(appointmentId||time);return {json:{...j,appointmentId,time,hasKey}};});"}},{"id":"IfHasIdOrTime","name":"tem id/time?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2340,420],"parameters":{"conditions":{"boolean":[{"value1":"={{$json.hasKey}}","value2":true}]}}},{"id":"WahaAskIdTime","name":"WAHA Ask Id/Time","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2620,400],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Envie o código do agendamento ou o horário.\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ApiCancel","name":"API Cancel","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2620,460],"parameters":{"url":"http://barberbook-api:8080/api/cancel","method":"POST","jsonParameters":true,"options":{"fullResponse":true},"headerParametersJson":"={\"Content-Type\":\"application/json\"}","bodyParametersJson":"={\"appointmentId\":\"{{$json.appointmentId || null}}\",\"reason\":\"Solicitado via WhatsApp\"}"}},{"id":"IfCancelOK","name":"cancel ok?","type":"n8n-nodes-base.if","typeVersion":1,"position":[2900,460],"parameters":{"conditions":{"number":[{"value1":"={{$json.statusCode}}","operation":"equal","value2":200}]}}},{"id":"WahaCancelOK","name":"WAHA Cancelado","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3180,440],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Cancelado ✅\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"WahaCancelFail","name":"WAHA Cancel Falha","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[3180,520],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Não consegui cancelar. Pode verificar o código/horário?\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"RespondOK","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[3460,480],"parameters":{"responseFormat":"string","responseBody":"OK","responseCode":200}},{"id":"ReplyRemarcar","name":"WAHA Reply remarcar","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[2080,540],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Ok, vamos remarcar. Qual a nova data (YYYY-MM-DD)?\",\"reply_to\":\"{{$json.messageId}}\"}"}},{"id":"ReplyOutro","name":"WAHA Reply outro","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position")[2080,660],"parameters":{"url":"http://waha:3000/api/sendText","method":"POST","jsonParameters":true,"options":{},"bodyParametersJson":"={\"session\":\"{{$json.session}}\",\"chatId\":\"{{$json.chatId}}\",\"text\":\"Posso ajudar com agendar, cancelar ou remarcar.\",\"reply_to\":\"{{$json.messageId}}\"}"}}],"connections":{"Webhook":{"main":[[{"node":"Parse WAHA","type":"main","index":0}]]},"Parse WAHA":{"main":[[{"node":"fromMe?","type":"main","index":0},{"node":"Merge WAHA+AI","type":"main","index":0}]]},"fromMe?":{"main":[[{"node":"WAHA Seen","type":"main","index":0}],[{"node":"Gemini Intent","type":"main","index":0}]]},"WAHA Seen":{"main":[[{"node":"Respond OK (fromMe)","type":"main","index":0}]]},"Gemini Intent":{"main":[[{"node":"Parse AI","type":"main","index":0}]]},"Parse AI":{"main")[[{"node":"Merge WAHA+AI","type":"main","index":1}]]},"Merge WAHA+AI":{"main":[[{"node":"Roteia por intent","type":"main","index":0}]]},"Roteia por intent":{"main":[[{"node":"API Services","type":"main","index":0},{"node":"Merge Ag WAHA+AI","type":"main","index":1}],[{"node":"Extract IdOrTime","type":"main","index":0}],[{"node":"WAHA Reply remarcar","type":"main","index":0}],[{"node":"WAHA Reply outro","type":"main","index":0}]]},"API Services":{"main")[[{"node":"Gemini Resolve Service","type":"main","index":0},{"node":"Merge Ag All","type":"main","index":1}]]},"Gemini Resolve Service":{"main":[[{"node":"Merge Ag WAHA+AI","type":"main","index":0}]]},"Merge Ag WAHA+AI":{"main":[[{"node":"Merge Ag All","type":"main","index":0}]]},"Merge Ag All":{"main":[[{"node":"Map Service Id","type":"main","index":0}]]},"Map Service Id":{"main")[[{"node":"Service found?","type":"main","index":0}]]},"Service found?":{"main":[[{"node":"Date missing?","type":"main","index":0}],[{"node":"WAHA Opções","type":"main","index":0}]]},"WAHA Opções":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Date missing?":{"main":[[{"node":"WAHA Ask Date","type":"main","index":0}],[{"node":"Gemini Normalize Date","type":"main","index":0},{"node":"Merge Date WAHA","type":"main","index":1}]]},"WAHA Ask Date":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"Gemini Normalize Date":{"main")[[{"node":"Merge Date WAHA","type":"main","index":0}]]},"Merge Date WAHA":{"main":[[{"node":"Apply Date","type":"main","index":0}]]},"Apply Date":{"main":[[{"node":"Date valid?","type":"main","index":0}]]},"Date valid?":{"main":[[],[{"node":"WAHA Invalid Date","type":"main","index":0}]]},"WAHA Invalid Date":{"main")[[{"node":"Respond OK","type":"main","index":0}]]},"Extract IdOrTime":{"main":[[{"node":"tem id/time?","type":"main","index":0}]]},"tem id/time?":{"main":[[{"node":"API Cancel","type":"main","index":0}],[{"node":"WAHA Ask Id/Time","type":"main","index":0}]]},"WAHA Ask Id/Time":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"API Cancel":{"main":[[{"node":"cancel ok?","type":"main","index":0}]]},"cancel ok?":{"main":[[{"node":"WAHA Cancelado","type":"main","index":0}],[{"node":"WAHA Cancel Falha","type":"main","index":0}]]},"WAHA Cancelado":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Cancel Falha":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply remarcar":{"main":[[{"node":"Respond OK","type":"main","index":0}]]},"WAHA Reply outro":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}},"active":false,"settings":{},"staticData":{}}
